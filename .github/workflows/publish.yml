<<<<<<< HEAD
name: "CLA Assistant"
=======
name: CLA Assistant + Grants Site Deploy

>>>>>>> master
on:
  issue_comment:
    types: [created]
  pull_request_target:
<<<<<<< HEAD
    types: [opened,closed,synchronize]

# explicitly configure permissions, in case your GITHUB_TOKEN workflow permissions are set to read-only in repository settings
permissions:
  actions: write
  contents: write
  pull-requests: write
  statuses: write

jobs:
  CLAAssistant:
=======
    types: [opened, closed, synchronize]
  push:
    branches: [master]

permissions:
  contents: write
  pull-requests: write
  statuses: write
  actions: write
  pages: write
  id-token: write

jobs:
  cla-assistant:
    name: CLA Assistant
>>>>>>> master
    runs-on: ubuntu-latest
    if: github.event_name != 'push'

    steps:
<<<<<<< HEAD
      - name: "CLA Assistant"
        if: (github.event.comment.body == 'recheck' || github.event.comment.body == 'I have read and hereby sign the Contributor License Agreement.') || github.event_name == 'pull_request_target'
        uses: contributor-assistant/github-action@v2.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # the below token should have repo scope and must be manually added by you in the repository's secret
          # This token is required only if you have configured to store the signatures in a remote repository/organization
=======
      - name: CLA Assistant
        if: >
          (github.event.comment.body == 'recheck' ||
           github.event.comment.body == 'I have read and hereby sign the Contributor License Agreement.') ||
           github.event_name == 'pull_request_target'
        uses: contributor-assistant/github-action@v2.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
>>>>>>> master
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        with:
          path-to-signatures: 'signatures/version1/cla.json'
          path-to-document: 'https://github.com/w3f/Grants-Program/blob/master/docs/Support%20Docs/T%26Cs.md'
<<<<<<< HEAD
          # branch should not be protected
          branch: 'master'
          allowlist: Pray4Lovee,takahser,Noc2,PieWol,keeganquigley,laboon,github-actions[bot]

         # the followings are the optional inputs - If the optional inputs are not given, then default values will be taken
          remote-organization-name: w3f
          remote-repository-name: grants-cla
          #create-file-commit-message: 'For example: Creating file for storing CLA Signatures'
          #signed-commit-message: 'For example: $contributorName has signed the CLA in $owner/$repo#$pullRequestNo'
          custom-notsigned-prcomment: 'Thank you for your submission, we really appreciate it. Like many open source projects, we ask that you sign our [Contributor License Agreement](https://github.com/w3f/Grants-Program/blob/master/docs/Support%20Docs/T%26Cs.md) before we can accept your contribution. Please submit the following text as a separate comment:'
          custom-pr-sign-comment: 'I have read and hereby sign the Contributor License Agreement.'
          #custom-allsigned-prcomment: 'pull request comment when all contributors has signed, defaults to **CLA Assistant Lite bot** All Contributors have signed the CLA.'
          lock-pullrequest-aftermerge: false # if you don't want this bot to automatically lock the pull request after merging (default - true)
          #use-dco-flag: true - If you are using DCO instead of CLA
=======
          branch: 'master'
          allowlist: Pray4Lovee,takahser,Noc2,PieWol,keeganquigley,laboon,github-actions[bot]
          remote-organization-name: w3f
          remote-repository-name: grants-cla
          custom-notsigned-prcomment: >
            Thank you for your submission. Before we can proceed,
            please sign our Contributor License Agreement:
          custom-pr-sign-comment: 'I have read and hereby sign the Contributor License Agreement.'
          lock-pullrequest-aftermerge: false

  build-and-deploy:
    name: Build + Provenance + Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 60

    if: github.repository_owner == 'w3f' && github.actor == 'grants-deployer'

    environment:
      name: production
      url: https://grants.web3.foundation

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Build Static Site
        run: NODE_ENV=production yarn build

      - name: Generate Provenance
        run: |
          mkdir -p build/.provenance
          echo $GITHUB_SHA > build/.provenance/commit
          date -u +"%Y-%m-%dT%H:%M:%SZ" > build/.provenance/timestamp
          git log -1 --pretty=%B > build/.provenance/message
          sha256sum build/.provenance/commit > build/.provenance/commit.sha256
          sha256sum build/.provenance/message > build/.provenance/message.sha256
          cat build/.provenance/*.sha256 > build/.provenance/bundle.txt
          sha256sum build/.provenance/bundle.txt > build/.provenance/merkle

      - name: Deploy via grants-deployer
        env:
          ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
        run: |
          git config --global user.email "grants-deployer@users.noreply.github.com"
          git config --global user.name "grants-deployer"
          echo "machine github.com login grants-deployer password $ACCESS_KEY" > ~/.netrc
          yarn deploy

      - name: Archive Provenance
        uses: actions/upload-artifact@v4
        with:
          name: provenance-${{ github.sha }}
          path: build/.provenance

      - name: Alert Matrix on Failure
        if: failure()
        uses: fadenb/matrix-chat-message@v0.0.6
        with:
          homeserver: 'matrix.web3.foundation'
          token: ${{ secrets.MATRIX_TOKEN }}
          channel: ${{ secrets.MATRIX_CHANNEL_ID }}
          message: |
            âŒ Grants site publish FAILED
            Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
            Actor: ${{ github.actor }}
>>>>>>> master
