name: Publish website

on:
  push:
    branches:
      - master

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    name: Build + Provenance + Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 60

    if: github.repository_owner == 'w3f' && github.actor == 'grants-deployer'

    environment:
      name: production
      url: https://grants.web3.foundation

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: Install Dependencies
        run: |
          yarn install --frozen-lockfile

      - name: Build Static Site
        run: |
          NODE_ENV=production yarn build

      - name: Generate Provenance
        run: |
          mkdir -p build/.provenance
          echo $GITHUB_SHA > build/.provenance/commit
          date -u +"%Y-%m-%dT%H:%M:%SZ" > build/.provenance/timestamp
          git log -1 --pretty=%B > build/.provenance/message
          sha256sum build/.provenance/commit > build/.provenance/commit.sha256
          sha256sum build/.provenance/message > build/.provenance/message.sha256
          cat build/.provenance/*.sha256 > build/.provenance/bundle.txt
          sha256sum build/.provenance/bundle.txt > build/.provenance/merkle
          echo "=== Provenance bundled ==="

      - name: Deploy via GIT_USER
        env:
          GIT_USER: grants-deployer
          ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
          PUBLISHING: "true"
        run: |
          git config --global user.email "grants-deployer@users.noreply.github.com"
          git config --global user.name "grants-deployer"
          echo "machine github.com login grants-deployer password $ACCESS_KEY" > ~/.netrc
          yarn deploy

      - name: Archive Provenance
        uses: actions/upload-artifact@v4
        with:
          name: provenance-${{github.sha}}
          path: build/.provenance

      - if: ${{ failure() }}
        name: Alert Matrix
        uses: fadenb/matrix-chat-message@v0.0.6
        with:
          homeserver: 'matrix.web3.foundation'
          token: ${{ secrets.MATRIX_TOKEN }}
          channel: ${{ secrets.MATRIX_CHANNEL_ID }}
          message: |
            Website publish FAILURE
            Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
            Actor: ${{ github.actor }}
            Workflow: publish.yml
