name: CLA Assistant + Grants Site Deploy

on:
  issue_comment:
    types: [created]
  pull_request_target:
    types: [opened, closed, synchronize]
  push:
    branches: [master]

permissions:
  contents: write
  pull-requests: write
  statuses: write
  actions: write
  pages: write
  id-token: write

jobs:
  cla-assistant:
    name: CLA Assistant
    runs-on: ubuntu-latest
    if: github.event_name != 'push'

    steps:
      - name: CLA Assistant
        if: >
          (github.event.comment.body == 'recheck' ||
           github.event.comment.body == 'I have read and hereby sign the Contributor License Agreement.') ||
           github.event_name == 'pull_request_target'
        uses: contributor-assistant/github-action@v2.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        with:
          path-to-signatures: 'signatures/version1/cla.json'
          path-to-document: 'https://github.com/w3f/Grants-Program/blob/master/docs/Support%20Docs/T%26Cs.md'
          branch: 'master'
          allowlist: Pray4Lovee,takahser,Noc2,PieWol,keeganquigley,laboon,github-actions[bot]
          remote-organization-name: w3f
          remote-repository-name: grants-cla
          custom-notsigned-prcomment: >
            Thank you for your submission. Before we can proceed,
            please sign our Contributor License Agreement:
          custom-pr-sign-comment: 'I have read and hereby sign the Contributor License Agreement.'
          lock-pullrequest-aftermerge: false

  build-and-deploy:
    name: Build + Provenance + Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 60

    if: github.repository_owner == 'w3f' && github.actor == 'grants-deployer'

    environment:
      name: production
      url: https://grants.web3.foundation

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup NodeJS
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Build Static Site
        run: NODE_ENV=production yarn build

      - name: Generate Provenance
        run: |
          mkdir -p build/.provenance
          echo $GITHUB_SHA > build/.provenance/commit
          date -u +"%Y-%m-%dT%H:%M:%SZ" > build/.provenance/timestamp
          git log -1 --pretty=%B > build/.provenance/message
          sha256sum build/.provenance/commit > build/.provenance/commit.sha256
          sha256sum build/.provenance/message > build/.provenance/message.sha256
          cat build/.provenance/*.sha256 > build/.provenance/bundle.txt
          sha256sum build/.provenance/bundle.txt > build/.provenance/merkle

      - name: Deploy via grants-deployer
        env:
          ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
        run: |
          git config --global user.email "grants-deployer@users.noreply.github.com"
          git config --global user.name "grants-deployer"
          echo "machine github.com login grants-deployer password $ACCESS_KEY" > ~/.netrc
          yarn deploy

      - name: Archive Provenance
        uses: actions/upload-artifact@v4
        with:
          name: provenance-${{ github.sha }}
          path: build/.provenance

      - name: Alert Matrix on Failure
        if: failure()
        uses: fadenb/matrix-chat-message@v0.0.6
        with:
          homeserver: 'matrix.web3.foundation'
          token: ${{ secrets.MATRIX_TOKEN }}
          channel: ${{ secrets.MATRIX_CHANNEL_ID }}
          message: |
            ‚ùå Grants site publish FAILED
            Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
            Actor: ${{ github.actor }}
